---
title: "Pronosticos_Aplicacion_Modelos_Lineales_a_mis_datos"
author: "Sergi"
date: "2023-02-27"
output: html_document
---


## Aplicación de métodos de pronóstico lineales a la series de tiempo de A) Demanda_electrico y B )   

```{r}

library(tidyverse)      # data manipulation and visualization
library(lubridate)      # easily work with dates and times
library(fpp2)           # working with time series data
library(zoo)
library(ggplot2)
library(plyr)
library(dplyr)
library(knitr)
library(TTR)
library(hydroGOF)


```


### Let´s start wiht Demanda_electrico

We first import our data 
```{r}
#URL HPi5
#Demanda_electrico_importado<-read.csv("C:\\Users\\llell\\Documents\\MIS\\Second_semester\\Pronosticos_UNAM_HPi5\\pronosticos_UNAM_git\\pronosticos_UNAM_gitHub\\Demanda_electrico_2022_full1.csv", header= TRUE)

#URL HPi3
Demanda_electrico_importado<-read.csv("C:\\Users\\sergi\\OneDrive\\Documentos\\MIS_UNAM\\Segundo_semestre\\Pronosticos_UNAM_HPi3\\pronosticos_UNAM_git\\Demanda_electrico_2022_full1.csv", header= TRUE)
```


We checked the importing has worked 
```{r}
head(Demanda_electrico_importado)
summary(Demanda_electrico_importado)
typeof(Demanda_electrico_importado)
dim(Demanda_electrico_importado)
```



We change column Date in a data type of data by transforming our 'original' Date columns into an as.date column 

```{r}
Demanda_electrico_importado$Date <- as.Date(Demanda_electrico_importado$Date, format = "%m/%d/%Y")
head(Demanda_electrico_importado)
tail(Demanda_electrico_importado)
typeof(Demanda_electrico_importado)
dim(Demanda_electrico_importado)

```


#### Let´s see How it looks like time serie 

```{r}
Demanda_electrico_importado.ts<- ts(Demanda_electrico_importado$Demanded_Gas, frequency = 12, start =c(2005,1), end =c(2022,8))
head(Demanda_electrico_importado.ts)

typeof(Demanda_electrico_importado.ts)
dim(Demanda_electrico_importado.ts)
```


Then we plot the 'original demanded gas in electric time series'
```{r}
plot(Demanda_electrico_importado.ts, col = "red", main = "Demanda electrico 'original' ")

```



### Replication of  Holt Winter´s method in R for Demanda_electrico



LEt´s plot the forecast
```{r}
plot(Demanda_electrico_HW)

```

```{r}
Demanda_electrico_HW$fitted
```

##### HAGAMOS COMO TAL EL FORECAST DEL MODELO HOLT-WINTER PARA EL CASO DE DEMANDA_ELECTRICO
```{r}
Demanda_electrico_HW_forecast <- forecast(Demanda_electrico_HW, h=12, level=0.95)
Demanda_electrico_HW_forecast
```




Let´s plot the forecast generated by HoltWinters model in  R 

```{r}
plot(Demanda_electrico_HW_forecast)
```


Los ultimos publicaods por la SIE de 2022
```{r}
valores_reales_electrico <-c(3260,3010, 3063)
```


```{r}
valores_calculados_electrico <-c(3546.517, 3158.247, 3200.122)
```


```{r}
# Calculate MAPE
mape_electrico_HW <- mean(abs((valores_reales_electrico - valores_calculados_electrico) / valores_reales_electrico)) * 100
cat("The MAPE is:", round(mape,2),"%\n")

# Calculate RMSE
rmse_electrico_HW <- sqrt(mean((valores_reales_electrico - valores_calculados_electrico)^2))
cat("The RMSE is:", round(rmse,2),"\n")
```


### Ahora intentemos ajustar un modelo lineal de la Demanda de gas natural en el sector electrico en función de la Temperatura 

```{r}
head(Demanda_electrico)
```
```{r}
dim(Demanda_electrico)
```

```{r}
tend <- c(1:213)

mes=c("ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic")

rep_mes <- rep(mes,17)
rep_mes

rep_mes <-rep_mes[1:213] 
rep_mes

Demanda_electrico_frame <- data.frame(Demanda_electrico,rep_mes,tend)
Demanda_electrico_frame

```

```{r}
ajuste_electrico <- lm (Demanded_Gas~1 + rep_mes + tend, data=Demanda_electrico_frame)
ajuste_electrico
```
```{r}
summary(ajuste_electrico)
```

```{r}
Demanded_gas <-c(3260,3010, 3063)
rep_mes <- c("sep", "oct", "nov")
tend <- c(214:216) 

predict_frame <- data.frame(Demanded_gas,rep_mes,tend )
predict_frame
```
```{r}
prediccion_electrico <- predict(ajuste_electrico,predict_frame, se.fit = TRUE )
prediccion_electrico
```

```{r}
valores_calculados_electrico2 <- prediccion_electrico$fit

# Calculate MAPE
mape_electrico_lm <- mean(abs((valores_reales_electrico - valores_calculados_electrico2) / valores_reales_electrico)) * 100
cat("The MAPE is:", round(mape,2),"%\n")

# Calculate RMSE
rmse_electrico_lm <- sqrt(mean((valores_reales_electrico - valores_calculados_electrico2)^2))
cat("The RMSE is:", round(rmse,2),"\n")
```




Importamos la data historica del clima 
```{r}
#URL HPi3
Temperatura_historico_importado<-read.csv("Temperatura_Media_CDMX_pron.csv", header= TRUE)
Temperatura_historico_importado

```

Separamos la data XE:Demanda_electrico de 2015 a 2022 y YY:Temperatura promedio 

```{r}
XE <- Demanda_electrico$Demanded_Gas[118:213]
XE
```


```{r}
TT <- Temperatura_historico_importado$Temperature
TT
```



```{r}
XE <- as.matrix(c(XE), nrow=96, ncol=1)
XE

TT <- as.matrix(c(TT),nrow=96, ncol=1)
TT

```


Construimos como tal el data.Frame




```{r}
TabData_elctrcio <- cbind(TT,XE)
colnames(TabData_elctrcio) <- c("Temperature","Demanda_electrico")

##Conviritiendo en data.frame
TabData_frame_electrico<- as.data.frame(TabData_elctrcio)
TabData_frame_electrico

plot(TabData_frame_electrico$Demanda_electrico,TabData_frame_electrico$Temperatura, pch = 16, cex= 1.5, xlab="Temperatura", ylab="Demanda_electrico")
     
```



Viendo la correlación entre las variables


```{r}
TabData_frame_electrico <- na.omit(TabData_frame_electrico)
```


```{r}
cor(TabData_frame_electrico)
```


```{r}
names(TabData_frame_electrico)

```


### Vamos a ajustar el modelo lineal
```{r}
modelo_lineal_electrico <- lm(TabData_frame_electrico$Demanda_electrico ~1 + TabData_frame_electrico$Temperature)

modelo_lineal_electrico
```

### Analizando el modelo lineal 

```{r}
summary(modelo_lineal_electrico)
```

### Diagnostico de residuales

```{r}
plot(modelo_lineal_electrico)
```






### Now with Demanda_petrolero

We first import our data 
```{r}
#URL HPi5
#Demanda_petrolero_importado<-read.csv("C:\\Users\\llell\\Documents\\MIS\\Second_semester\\Pronosticos_UNAM_HPi5\\pronosticos_UNAM_git\\pronosticos_UNAM_gitHub\\Demanda_petrolero_2022_full1.csv", header= TRUE)

#URL HPi3
Demanda_petrolero_importado<-read.csv("C:\\Users\\sergi\\OneDrive\\Documentos\\MIS_UNAM\\Segundo_semestre\\Pronosticos_UNAM_HPi3\\pronosticos_UNAM_git\\Demanda_petrolero_2022_full1.csv", header= TRUE)
```




We checked the importing has worked 
```{r}
head(Demanda_petrolero_importado)
summary(Demanda_petrolero_importado)
typeof(Demanda_petrolero_importado)
dim(Demanda_petrolero_importado)
```


We add a new columns in a data type of data by transforming our 'original' Date columns into an as.date column 

```{r}
Demanda_petrolero_importado$as.date <- as.Date(Demanda_petrolero_importado$Date, format = "%m/%d/%Y")
head(Demanda_petrolero_importado)
tail(Demanda_petrolero_importado)
typeof(Demanda_petrolero_importado)
dim(Demanda_petrolero_importado)

```


#### Let´s see How it looks like time serie 

```{r}
Demanda_petrolero_importado.ts<- ts(Demanda_petrolero_importado$Demanded_Gas, frequency = 12, start =c(2005,1), end =c(2022,8))
Demanda_petrolero_importado.ts

typeof(Demanda_petrolero_importado.ts)
dim(Demanda_petrolero_importado.ts)
```


Then we plot the 'original demanded gas in electric time series'
```{r}
plot(Demanda_petrolero_importado.ts, col = "black", main = "Demanda petrolero 'original' ")

```



```{r}
#Código para descomponer series y ver cada mes por separado 

par(mfrow=c(3,2))

mes=c("ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic")

for (j in 1:12)
{
  
  bp2=window(Demanda_petrolero_importado.ts,start=c(2005,j), deltat=1)
  plot(bp2, main=paste("mes",mes[j]),type="o",ylim=c(0,3000))
  
}
j=12
bp2=window(Demanda_petrolero_importado.ts,start=c(2005,j), deltat=1)
plot(bp2, main=paste("mes",mes[j]),type="o",ylim=c(0,3000))


tiempo=c(1:213)

ajuste2=lm(bp2~1+tiempo)       #y=beta0+beta1*x
summary(ajuste2)
plot(ajuste2)
serie2=as.data.frame(tiempo,bp2)

bp2=as.vector(bp2)
length(bp2)
summary(bp2)
is(bp2)
plot(bp2, type="o")
bp2

```




Para "descomponer" la serie podemos: 
Source: https://rpubs.com/davoodastaraky/TSA1



REMOVIENDO LOS NAs de Demanda_petrolero_importado.ts
```{r}

Demanda_petrolero_importado.ts <- na.omit(Demanda_petrolero_importado.ts)
Demanda_petrolero_importado.ts
```


```{r}
length(Demanda_petrolero_importado.ts)
```


```{r}
Demanda_petrolero_importado.ts <- as.numeric(Demanda_petrolero_importado.ts)
Demanda_petrolero_importado.ts
```


```{r}
Demanda_petrolero_importado.ts <- na.omit(Demanda_petrolero_importado.ts)
Demanda_petrolero_importado.ts
```



```{r}
Demanda_petroleroDC <- decompose(as.numeric(Demanda_petrolero_importado.ts))
Demanda_petroleroDC
```



```{r}
##Demanda_petroleroDC <- decompose(Demanda_petrolero_importado.ts)
##Demanda_petroleroDC
```

This will decompose your time series using stl() and plot the decomposed time series. You can replace Demanda_petrolero_importado.ts 

The error message series is not periodic or has less than two periods occurs when the data you are giving either lacks a frequency or the frequency is greater than one-half of the length of the vector

```{r}
# Decompose your time series using stl()
##Demanda_petrolero_importado.stl <- stl(Demanda_petrolero_importado.ts, s.window = "periodic")

# Plot the decomposed time series
##plot(Demanda_petrolero_importado.stl)
```



### Now with Demanda_residencial


We first import our data 
```{r}
#URL HPi5
#Demanda_electrico_importado<-read.csv("C:\\Users\\llell\\Documents\\MIS\\Second_semester\\Pronosticos_UNAM_HPi5\\pronosticos_UNAM_git\\pronosticos_UNAM_gitHub\\Demanda_electrico_2022_full1.csv", header= TRUE)

#URL HPi3
Demanda_residencial_importado<-read.csv("C:\\Users\\sergi\\OneDrive\\Documentos\\MIS_UNAM\\Segundo_semestre\\Pronosticos_UNAM_HPi3\\pronosticos_UNAM_git\\Demanda_residencial_2022_full1.csv", header= TRUE)
```



We checked the importing has worked 
```{r}
head(Demanda_residencial_importado)
summary(Demanda_residencial_importado)
typeof(Demanda_residencial_importado)
dim(Demanda_residencial_importado)
```


We add a new columns in a data type of data by transforming our 'original' Date columns into an as.date column 

```{r}
Demanda_residencial_importado$as.date <- as.Date(Demanda_residencial_importado$Date, format = "%m/%d/%Y")
head(Demanda_residencial_importado)
tail(Demanda_residencial_importado)
typeof(Demanda_residencial_importado)
dim(Demanda_residencial_importado)

```


#### Let´s see How it looks like time serie 

```{r}
Demanda_residencial_importado.ts<- ts(Demanda_residencial_importado$Demanded_Gas, frequency = 12, start =c(2005,1), end =c(2022,8))
Demanda_residencial_importado.ts

typeof(Demanda_residencial_importado.ts)
dim(Demanda_residencial_importado.ts)
```

```{r}
head(Demanda_residencial_importado)

demanded_residencial_pre_pandemia <- Demanda_residencial_importado$Demanded_Gas[1:175]
demanded_residencial_pre_pandemia

date_residencial_pre_pandemia <- Demanda_residencial_importado$as.date[1:175]
date_residencial_pre_pandemia 


```



```{r}
residencal_pre_pandemia_frame <- data.frame(demanded_residencial_pre_pandemia, date_residencial_pre_pandemia)
head(residencal_pre_pandemia_frame)

tail(residencal_pre_pandemia_frame)
```

```{r}
Demanda_residencial_importado_pre.ts<- ts(residencal_pre_pandemia_frame$demanded_residencial_pre_pandemia, frequency = 12, start =c(2005,1))


typeof(Demanda_residencial_importado_pre.ts)
dim(Demanda_residencial_importado_pre.ts)
plot(Demanda_residencial_importado_pre.ts)
```




Then we plot the 'original demanded gas in electric time series'
```{r}
plot(Demanda_residencial_importado.ts, col = "violet", main = "Demanda residencial 'original' ")

```



```{r}
#Código para descomponer series y ver cada mes por separado 

par(mfrow=c(3,4))

mes=c("ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic")

for (j in 1:12)
{
  
  bp3=window(Demanda_residencial_importado.ts,start=c(2005,j), deltat=1)
  plot(bp3, main=paste("mes",mes[j]),type="o",ylim=c(0,250))
  
}
j=12
bp3=window(Demanda_residencial_importado.ts,start=c(2005,j), deltat=1)
plot(bp3, main=paste("mes",mes[j]),type="o",ylim=c(0,250))


tiempo=c(1:213)

ajuste3=lm(bp3~1+tiempo)       #y=beta0+beta1*x
summary(ajuste3)
plot(ajuste3)
serie3=as.data.frame(tiempo,bp3)

bp3=as.vector(bp3)
length(bp3)
summary(bp3)
is(bp3)
plot(bp3, type="o")
bp3

```





Para "descomponer" la serie podemos: 
Source: https://rpubs.com/davoodastaraky/TSA1



REMOVIENDO LOS NAs de Demanda_residencial_importado.ts
```{r}

Demanda_residencial_importado.ts <- na.omit(Demanda_residencial_importado.ts)
Demanda_residencial_importado.ts
```


```{r}
Demanda_residencialDC <- decompose(Demanda_residencial_importado.ts)
Demanda_residencialDC
```


Now let´s plot the (trend, seasonal and random components of the decompose analysisi)

```{r}
plot(Demanda_residencialDC)
```


###Seasonally Adjusting
If you have a seasonal time series, you can seasonally adjust the series by estimating the seasonal component, and subtracting it from the original time series. We can see below that time time series simply consists of the trend and random components.



Calculemos los valores de la data, restando "el componente de seaonalidad" 
```{r}
Demanda_residencial_SINSeason <- Demanda_residencial_importado.ts - Demanda_residencialDC$seasonal
Demanda_residencial_SINSeason
plot.ts(Demanda_residencial_SINSeason, main = "Demanda sin componente de seasonalidad", col="lightblue")
```






### Replication of  Holt Winter´s method in R for Demanda_residencial

Then we are able to apply the HoltWinters method 

```{r}
Demanda_residencial_HW <- HoltWinters(Demanda_residencial_importado.ts)
head(Demanda_residencial_HW)
tail(Demanda_residencial_HW)
typeof(Demanda_residencial_HW)
```


Let´s see only the SMOTHED VALUES
```{r}
Smoothed_values_Demanda_residencial_HW <- Demanda_residencial_HW$x

head(Smoothed_values_Demanda_residencial_HW)
tail(Smoothed_values_Demanda_residencial_HW)
typeof(Smoothed_values_Demanda_residencial_HW)
dim(Smoothed_values_Demanda_residencial_HW)

```


SMOOTHED VALUS ARE EQUAL THAN ORIGINAL ONES
```{r}
plot(Demanda_residencial_importado.ts, col = "red", main = "Demanda electrico Holt-winters ")
lines(Smoothed_values_Demanda_residencial_HW , col='gray')
```



LEt´s plot the forecast
```{r}
plot(Demanda_residencial_HW)

```

```{r}
Demanda_residencial_HW$fitted
```

##### HAGAMOS COMO TAL EL FORECAST DEL MODELO HOLT-WINTER PARA EL CASO DE DEMANDA_ELECTRICO
```{r}
Demanda_residencial_HW_forecast <- forecast(Demanda_residencial_HW, h=12, level=0.95)
Demanda_residencial_HW_forecast
```

Let´s plot the forecast generated by HoltWinters model in  R 

```{r}
plot(Demanda_residencial_HW_forecast)
```




### Aplicaicón de modelo lineal para Demanda_residencial

Separamos la data XE:Demanda_electrico de 2015 a 2022 y YY:Temperatura promedio 

```{r}
XR <- Demanda_residencial_importado$Demanded_Gas[118:213]
XR
```





```{r}
XR <- as.matrix(c(XR), nrow=96, ncol=1)
XR

TT <- as.matrix(c(TT),nrow=96, ncol=1)
TT

```


Construimos como tal el data.Frame




```{r}
TabData_residencial <- cbind(TT,XE)
colnames(TabData_residencial) <- c("Temperature","Demanda_residencial")

##Conviritiendo en data.frame
TabData_frame_residencial<- as.data.frame(TabData_residencial)
TabData_frame_residencial

plot(TabData_frame_residencial$Demanda_electrico,TabData_frame_residencial$Temperatura, pch = 16, cex= 1.5, xlab="Temperatura", ylab="Demanda_residencial")
     
```



Viendo la correlación entre las variables



```{r}
TabData_frame_residencial <- na.omit(TabData_frame_residencial)
```




```{r}
cor(TabData_frame_residencial)
```


### Vamos a ajustar el modelo lineal
```{r}
modelo_lineal_residencial <- lm(TabData_frame_residencial$Demanda_residencial ~1 + TabData_frame_electrico$Temperature)
modelo_lineal_residencial
```

### Analizando el modelo lineal 

```{r}
summary(modelo_lineal_residencial)
```

### Diagnostico de residuales

```{r}
plot(modelo_lineal_residencial)
```





