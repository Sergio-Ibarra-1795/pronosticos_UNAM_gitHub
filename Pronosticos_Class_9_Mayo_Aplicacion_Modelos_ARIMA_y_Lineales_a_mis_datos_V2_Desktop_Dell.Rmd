---
title: "Pronosticos_Class_9_Mayo_Aplicacion_Modelos_ARIMA_y_Lineales_a_mis_datos"
author: "Sergi"
date: "2023-02-27"
output: html_document
---


## Aplicación de métodos de pronóstico lineales a la series de tiempo de A) Demanda_electrico y B )Demanda_residencial   

```{r}

library(tidyverse)      # data manipulation and visualization
library(lubridate)      # easily work with dates and times
library(fpp2)           # working with time series data
library(zoo)
library(ggplot2)
library(plyr)
library(dplyr)
library(knitr)
library(TTR)
library(hydroGOF)


```


## Empezeos el análisis con los datos de Demanda_electrico

We first import our data 
```{r}
#URL HPi5
#Demanda_electrico_importado<-read.csv("C:\\Users\\llell\\Documents\\MIS\\Second_semester\\Pronosticos_UNAM_HPi5\\pronosticos_UNAM_git\\pronosticos_UNAM_gitHub\\Demanda_electrico_2022_full1.csv", header= TRUE)

#URL HPi3
#Demanda_electrico_importado<-read.csv("C:\\Users\\sergi\\OneDrive\\Documentos\\MIS_UNAM\\Segundo_semestre\\Pronosticos_UNAM_HPi3\\pronosticos_UNAM_git\\Demanda_electrico_2022_full1.csv", header= TRUE)

#URL DesktopDell
Demanda_electrico_importado<-read.csv("Demanda_electrico_2022_full1.csv", header= TRUE)

```


We checked the importing has worked 
```{r}
head(Demanda_electrico_importado)
summary(Demanda_electrico_importado)
typeof(Demanda_electrico_importado)
dim(Demanda_electrico_importado)
```



We change column Date in a data type of data by transforming our 'original' Date columns into an as.date column 

```{r}
Demanda_electrico_importado$Date <- as.Date(Demanda_electrico_importado$Date, format = "%m/%d/%Y")
head(Demanda_electrico_importado)
tail(Demanda_electrico_importado)
typeof(Demanda_electrico_importado)
dim(Demanda_electrico_importado)

```


#### Serie de tiempo de los datos de Demanda_electrico

```{r}
Demanda_electrico_importado.ts<- ts(Demanda_electrico_importado$Demanded_Gas, frequency = 12, start =c(2005,1))
head(Demanda_electrico_importado.ts)

typeof(Demanda_electrico_importado.ts)
dim(Demanda_electrico_importado.ts)
```


Then we plot the 'original demanded gas in electric time series'
```{r}
plot(Demanda_electrico_importado.ts, col = "red", main = "Demanda electrico 'original' ")

```




#### Separamos el df Demanda_electrico_importado en data sets training y  testing  


```{r}

# Split the data into training and testing sets


# Subset the data to keep rows from the beginning until train_end and all columns
Demanda_electrico_importado_train <- Demanda_electrico_importado[1:201,]
head(Demanda_electrico_importado_train)
tail(Demanda_electrico_importado_train)
dim(Demanda_electrico_importado_train)



```

```{r}
# Subset the data to keep rows from the beginning until train_end and all columns


Demanda_electrico_importado_test <- Demanda_electrico_importado[202:213,]
head(Demanda_electrico_importado_test)
dim(Demanda_electrico_importado_test)



```




## Ahora intentemos ajustar un 'modelo lineal generalizado simple' para la Demanda de gas natural en el sector electrico 


```{r}
tend <- c(1:213)

dim(tend_train)

mes=c("ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic")

rep_mes <- rep(mes,18)



Demanda_electrico_train_frame <- data.frame(Demanda_electrico_importado_train,rep_mes[1:201],tend[1:201])
head(Demanda_electrico_train_frame)
tail(Demanda_electrico_train_frame)
dim(Demanda_electrico_train_frame)

```

```{r}
Demanda_electrico_train_frame$rep_mes <-Demanda_electrico_train_frame$rep_mes.1.201
Demanda_electrico_train_frame$rep_mes.1.201. <- NULL
Demanda_electrico_train_frame$tend <-Demanda_electrico_train_frame$tend.1.201.
Demanda_electrico_train_frame$tend.1.201. <- NULL

Demanda_electrico_train_frame
```


#### Se 'entrena' (en este caso, se define) al modelo lineal con los datos de train 

```{r}
demanda_electrico_lineal_simple1 <- glm (Demanded_Gas~1 + rep_mes + tend, data=Demanda_electrico_train_frame, family = gaussian())
demanda_electrico_lineal_simple1
```


```{r}
summary(demanda_electrico_lineal_simple1)
```
```{r}
plot(demanda_electrico_lineal_simple1)
```

#### Testeo del 'modelo lineal generalizado simple'  haciendo la predición de los datos de test 


```{r}


Demanda_electrico_test_frame <- data.frame(Demanda_electrico_importado_test,rep_mes[202:213],tend[202:213])
head(Demanda_electrico_test_frame)
tail(Demanda_electrico_test_frame)
dim(Demanda_electrico_test_frame)

```

```{r}
Demanda_electrico_test_frame$rep_mes <-Demanda_electrico_test_frame$rep_mes.202.213.
Demanda_electrico_test_frame$rep_mes.202.213. <- NULL
Demanda_electrico_test_frame$tend <-Demanda_electrico_test_frame$tend.202.213.
Demanda_electrico_test_frame$tend.202.213. <- NULL

Demanda_electrico_test_frame
```




```{r}
prediccion_demanda_electrico_lineal_simple1 <- predict(demanda_electrico_lineal_simple1, newdata = Demanda_electrico_test_frame, se.fit = TRUE)


prediccion_demanda_electrico_lineal_simple1
```


#### Calculo de errores del 'modelo lineal generalizado simple' para los datos de Demanda_electrico

```{r}
valores_calculados_demanda_electrico_lineal_simple1 <- prediccion_demanda_electrico_lineal_simple1$fit

# Calculate MAPE
mape_electrico_lm_simple1 <- mean(abs((Demanda_electrico_importado$Demanded_Gas[202:213] - valores_calculados_demanda_electrico_lineal_simple1) / Demanda_electrico_importado$Demanded_Gas[202:213])) * 100
cat("The MAPE is:", round(mape_electrico_lm_simple1,2),"%\n")

# Calculate RMSE
rmse_electrico_lm_simple1 <- sqrt(mean((Demanda_electrico_importado$Demanded_Gas[202:213] - valores_calculados_demanda_electrico_lineal_simple1)^2))
cat("The RMSE is:", round(rmse_electrico_lm_simple1,2),"\n")
```


## Intentemos un 'modelo lineal simple' de Demanda_electrico ahora como función del precio de importacion de gas , PIB de Mexico y poblacion de mexico

Precio de Importación de gas natural: https://www.eia.gov/dnav/ng/hist/n9132mx3M.htm

PIB Mexico: https://www.banxico.org.mx/SieInternet/consultarDirectorioInternetAction.do?sector=2&accion=consultarCuadro&idCuadro=CR201&locale=es

Poblacion en México: https://www.inegi.org.mx/app/areasgeograficas/#tabMCcollapse-Indicadores



##### Construimos como tal el data.Frame para el modelo lineal de Demanda_electrico con la Temperatura 


```{r}
#URL DesktopDell

Demanda_electrico_importado_mas_datos <- read.csv("Demanda_electrico_2022_mas_datos_full1_resumen.csv", header = TRUE, encoding = "UTF-8")

```

```{r}
head(Demanda_electrico_importado_mas_datos)
summary(Demanda_electrico_importado_mas_datos)
typeof(Demanda_electrico_importado_mas_datos)
dim(Demanda_electrico_importado_mas_datos)
```


```{r}
Demanda_electrico_importado_mas_datos$Date <- as.Date(Demanda_electrico_importado_mas_datos$Date, format = "%m/%d/%Y")
head(Demanda_electrico_importado_mas_datos)
tail(Demanda_electrico_importado_mas_datos)
typeof(Demanda_electrico_importado_mas_datos)
dim(Demanda_electrico_importado_mas_datos)

```

```{r}
Demanda_electrico_importado_mas_datosDemanded_Gas <- as.numeric(Demanda_electrico_importado_mas_datos$Demanded_Gas)

Demanda_electrico_importado_mas_datos$Import_total_price_Dolares <- as.numeric(Demanda_electrico_importado_mas_datos$Import_total_price_Dolares)

Demanda_electrico_importado_mas_datos$PIB_Millones_de_Dolares <- as.numeric(Demanda_electrico_importado_mas_datos$PIB_Millones_de_Dolares)

Demanda_electrico_importado_mas_datos$Poblacion_en_Mexico <- as.numeric(Demanda_electrico_importado_mas_datos$Poblacion_en_Mexico)
```



#### Separamos el df Demanda_electrico_importado_mas_datos en data sets training y  testing  


```{r}

# Split the data into training and testing sets


# Subset the data to keep rows from the beginning until train_end and all columns
Demanda_electrico_importado_mas_datos_train <- Demanda_electrico_importado_mas_datos[1:201,]
head(Demanda_electrico_importado_mas_datos_train)
tail(Demanda_electrico_importado_mas_datos_train)
dim(Demanda_electrico_importado_mas_datos_train)



```


```{r}
# Subset the data to keep rows from the beginning until train_end and all columns


Demanda_electrico_importado_mas_datos_test <- Demanda_electrico_importado_mas_datos[202:213,]
head(Demanda_electrico_importado_mas_datos_test)
dim(Demanda_electrico_importado_mas_datos_test)



```




##### Viendo la correlación entre las variables Import_total_price_Dolares, PIB_Millones_de_Dolares , Poblacion_en_Mexico y Demanda_electrico



```{r}
cor_matrix_demanda_electrico <- cor(Demanda_electrico_importado_mas_datos_train[,2:5])
cor_matrix_demanda_electrico

```


##### Vamos a ajustar el modelo lineal de Demanda_electrico con Poblacion_en_Mexico y PIB_Millones_de_Dolares

```{r}
modelo_lineal_electrico_mas_datos1 <- glm(Demanda_electrico_importado_mas_datos_train$Demanded_Gas ~1 + Demanda_electrico_importado_mas_datos_train$Poblacion_en_Mexico + Demanda_electrico_importado_mas_datos_train$PIB_Millones_de_Dolares, family = gaussian(link="identity"))

modelo_lineal_electrico_mas_datos1
```

```{r}
# Modified GLM call with changed variable names
new_formula <- as.formula(paste("Demanded_Gas ~ 1 + Poblacion_en_Mexico + PIB_Millones_de_Dolares",
                               collapse = " + "))

modelo_lineal_electrico_mas_datos1 <- glm(formula = new_formula,
    data = Demanda_electrico_importado_mas_datos_train,
    family = gaussian(link = "identity"))

```


##### Analizando el modelo lineal Demanda_electrico con Poblacion_en_Mexico y PIB_Millones_de_Dolares 

```{r}
summary(modelo_lineal_electrico_mas_datos1)
```

##### Diagnostico de residuales Demanda_electrico con Poblacion_en_Mexico y PIB_Millones_de_Dolares

```{r}
plot(modelo_lineal_electrico_mas_datos1)
```


#### Predicicon con modelo  lineal Demanda_electrico con Poblacion_en_Mexico y PIB_Millones_de_Dolares
```{r}


prediccion_demanda_electrico_lineal_mas_datos1 <- predict(modelo_lineal_electrico_mas_datos1, newdata = Demanda_electrico_importado_mas_datos_test, se.fit = TRUE)


prediccion_demanda_electrico_lineal_mas_datos1

```



#### Claculo de ACF & PACF para el caso de la data de demanda del sector eléctrico 

```{r}
#  ACF (Autocorrelation function)
acf_demanda_electrico_tot <- acf(na.omit(Demanda_electrico_importado), lag.max = 100)
acf_demanda_electrico_tot

#  PACF (Partial Autocorrelation function)
pacf_demanda_electrico_tot <- pacf(na.omit(Demanda_electrico_importado))
pacf_demanda_electrico_tot
```



#### Determinación de ACF & PACF para el caso de la data de demanda del sector eléctrico 

```{r}
#install.packages("forecast")
library(forecast)


acf_demanda_electrico <- Acf(Demanda_electrico_importado.ts, lag.max = 100, plot = FALSE, ci.type = "ma")
acf_demanda_electrico


pacf_demanda_electrico <- Pacf(Demanda_electrico_importado.ts, lag.max = 100, plot = FALSE, ci.type = "ma")
pacf_demanda_electrico
```



##### ACF & PACF para los datos de Demanda_electrico sin 'estacionarizar '
```{r}
library(forecast)

# Compute ACF and PACF with ci.type
acf_demanda_electrico <- Acf(Demanda_electrico_importado.ts, lag.max = 100, plot = FALSE, ci.type = "ma")
pacf_demanda_electrico <- Pacf(Demanda_electrico_importado.ts, lag.max = 100, plot = FALSE, ci.type = "ma")

# Plot ACF with significant lags only
plot(acf_demanda_electrico$lag, acf_demanda_electrico$acf, type = "h", lwd = 2, xlab = "Lag", ylab = "ACF", ylim=c(-0.3,1), main = "Autocorrelation Function (ACF)")
abline(h = c(0.2, -0.2), lty = 2, col = "red")

# Plot PACF with significant lags only
plot(pacf_demanda_electrico$lag, pacf_demanda_electrico$acf, type = "h", lwd = 2, xlab = "Lag", ylab = "PACF", ylim=c(-0.3,1), main = "Partial Autocorrelation Function (PACF)")
abline(h = c(0.2, -0.2), lty = 2, col = "red")

```


#### Vamos a 'diferenciar la serie para hacerlo estacionaria'

```{r}
# Calculate the difference between consecutive elements
Demanda_electrico_diferencia <- diff(Demanda_electrico_importado.ts)

# Print the results
print(Demanda_electrico_diferencia)

```




##### ACF & PACF para los datos de Demanda_electrico 'estacionariazada'
```{r}
library(forecast)

# Compute ACF and PACF with ci.type
acf_demanda_electrico_differencia <- Acf(Demanda_electrico_diferencia, lag.max = 100, plot = FALSE, ci.type = "ma")
pacf_demanda_electrico_differencia <- Pacf(Demanda_electrico_diferencia, lag.max = 100, plot = FALSE, ci.type = "ma")

# Plot ACF with significant lags only
plot(acf_demanda_electrico_differencia$lag, acf_demanda_electrico_differencia$acf, type = "h", lwd = 2, xlab = "Lag", ylab = "ACF", ylim=c(-0.3,1), main = "Autocorrelation Function (ACF)")
abline(h = c(0.2, -0.2), lty = 2, col = "red")

# Plot PACF with significant lags only
plot(pacf_demanda_electrico_differencia$lag, pacf_demanda_electrico_differencia$acf, type = "h", lwd = 2, xlab = "Lag", ylab = "PACF", ylim=c(-0.3,1), main = "Partial Autocorrelation Function (PACF)")
abline(h = c(0.2, -0.2), lty = 2, col = "red")

```




##### Get training and testing sets 


```{r}

# Split the data into training and testing sets


# Subset the data to keep rows from the beginning until train_end and all columns
Demanda_electrico_differencia_train <- Demanda_electrico_diferencia[1:201]
Demanda_electrico_differencia_train



```

```{r}
# Subset the data to keep rows from the beginning until train_end and all columns


Demanda_electrico_differencia_test <- Demanda_electrico_diferencia[202:211]
Demanda_electrico_differencia_test



```



```{r}
library(forecast)

# Fit the ARIMA model
ARIMA_Demanda_electrico_1_0_1 <- Arima(Demanda_electrico_differencia_train, order=c(1,0,1))

# Print the model summary
summary(ARIMA_Demanda_electrico_1_0_1)

```



```{r}


# Get the predictors and residuals
predictions_ARIMA_Demanda_electrico_1_0_1 <- predict(ARIMA_Demanda_electrico_1_0_1, n.ahead = length(Demanda_electrico_differencia_test))


predictions_ARIMA_Demanda_electrico_1_0_1 <- as.numeric(unlist(predictions_ARIMA_Demanda_electrico_1_0_1))

print(predictions_ARIMA_Demanda_electrico_1_0_1)


```


```{r}
Demanda_electrico_differencia_test <- as.numeric(Demanda_electrico_differencia_test)
predictions_ARIMA_Demanda_electrico_1_0_1 <- as.numeric(predictions_ARIMA_Demanda_electrico_1_0_1)


residuals_ARIMA_Demanda_electrico_1_0_1 <- unlist(Demanda_electrico_differencia_test) - unlist(predictions_ARIMA_Demanda_electrico_1_0_1)

print(residuals_ARIMA_Demanda_electrico_1_0_1)

```




## Ahora hagamoslo para los datos de Demanda_residencial


We first import our data 
```{r}
#URL HPi5
#Demanda_electrico_importado<-read.csv("C:\\Users\\llell\\Documents\\MIS\\Second_semester\\Pronosticos_UNAM_HPi5\\pronosticos_UNAM_git\\pronosticos_UNAM_gitHub\\Demanda_electrico_2022_full1.csv", header= TRUE)

#URL HPi3
Demanda_residencial_importado<-read.csv("C:\\Users\\sergi\\OneDrive\\Documentos\\MIS_UNAM\\Segundo_semestre\\Pronosticos_UNAM_HPi3\\pronosticos_UNAM_git\\Demanda_residencial_2022_full1.csv", header= TRUE)
```



We checked the importing has worked 
```{r}
head(Demanda_residencial_importado)
summary(Demanda_residencial_importado)
typeof(Demanda_residencial_importado)
dim(Demanda_residencial_importado)
```


We change Date column in a data type of data by transforming our 'original' Date columns into an as.date column 

```{r}
Demanda_residencial_importado$Date <- as.Date(Demanda_residencial_importado$Date, format = "%m/%d/%Y")
head(Demanda_residencial_importado)
tail(Demanda_residencial_importado)
typeof(Demanda_residencial_importado)
dim(Demanda_residencial_importado)

```


#### Serie de tiempo para los datos de Demanda_residencial 

```{r}
Demanda_residencial_importado.ts<- ts(Demanda_residencial_importado$Demanded_Gas, frequency = 12, start =c(2005,1), end =c(2022,8))
Demanda_residencial_importado.ts

typeof(Demanda_residencial_importado.ts)
dim(Demanda_residencial_importado.ts)
```

```{r}
head(Demanda_residencial_importado)

demanded_residencial_pre_pandemia <- Demanda_residencial_importado$Demanded_Gas[1:175]
demanded_residencial_pre_pandemia

date_residencial_pre_pandemia <- Demanda_residencial_importado$as.date[1:175]
date_residencial_pre_pandemia 


```



```{r}
residencal_pre_pandemia_frame <- data.frame(demanded_residencial_pre_pandemia, date_residencial_pre_pandemia)
head(residencal_pre_pandemia_frame)

tail(residencal_pre_pandemia_frame)
```

```{r}
Demanda_residencial_importado_pre.ts<- ts(residencal_pre_pandemia_frame$demanded_residencial_pre_pandemia, frequency = 12, start =c(2005,1))


typeof(Demanda_residencial_importado_pre.ts)
dim(Demanda_residencial_importado_pre.ts)
plot(Demanda_residencial_importado_pre.ts)
```




Then we plot the 'original demanded gas in electric time series'
```{r}
plot(Demanda_residencial_importado.ts, col = "violet", main = "Demanda residencial 'original' ")

```


REMOVIENDO LOS NAs de Demanda_residencial_importado.ts
```{r}

Demanda_residencial_importado.ts <- na.omit(Demanda_residencial_importado.ts)
Demanda_residencial_importado.ts
```



#### Aplicaicón de modelo lineal para Demanda_residencial

Separamos la data XE:Demanda_electrico de 2015 a 2022 y YY:Temperatura promedio 

```{r}
XR <- Demanda_residencial_importado$Demanded_Gas[118:213]
XR
```


```{r}
XR <- as.matrix(c(XR), nrow=96, ncol=1)
XR

TT <- as.matrix(c(TT),nrow=96, ncol=1)
TT

```


Construimos como tal el data.Frame

```{r}
TabData_residencial <- cbind(TT,XE)
colnames(TabData_residencial) <- c("Temperature","Demanda_residencial")

##Conviritiendo en data.frame
TabData_frame_residencial<- as.data.frame(TabData_residencial)
TabData_frame_residencial

plot(TabData_frame_residencial$Demanda_electrico,TabData_frame_residencial$Temperatura, pch = 16, cex= 1.5, xlab="Temperatura", ylab="Demanda_residencial")
     
```



Viendo la correlación entre las variables



```{r}
TabData_frame_residencial <- na.omit(TabData_frame_residencial)
```




```{r}
cor(TabData_frame_residencial)
```


#### Vamos a ajustar el modelo lineal
```{r}
modelo_lineal_residencial <- lm(TabData_frame_residencial$Demanda_residencial ~1 + TabData_frame_electrico$Temperature)
modelo_lineal_residencial
```

#### Analizando el modelo lineal 

```{r}
summary(modelo_lineal_residencial)
```

#### Diagnostico de residuales

```{r}
plot(modelo_lineal_residencial)
```





